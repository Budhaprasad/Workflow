name: Read Issues & Clean Comments

on:
  workflow_dispatch:

permissions:
  issues: write  # Needed to read and update comments

jobs:
  process-issues:
    runs-on: ubuntu-latest

    steps:
      - name: Print comments and clean closed references
        uses: actions/github-script@v7
        with:
          script: |
            const issueRefRegex = /(\S+\/\S+#\d+|#\d+)/g;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open'
            });

            for (const issue of issues.data) {
              console.log(`\n#${issue.number}: ${issue.title}`);

              if (issue.comments === 0) {
                console.log('  üõë No comments.');
                continue;
              }

              const comments = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: issue.number
              });

              for (const comment of comments.data) {
                const original = comment.body;
                console.log(`\n  üó®Ô∏è Comment by ${comment.user.login}: ${original.substring(0, 100).replace(/\n/g, ' ')}...`);

                const refs = [...original.matchAll(issueRefRegex)];
                if (refs.length === 0) continue;

                let allClosed = true;

                for (const match of refs) {
                  const ref = match[0];
                  let refOwner = owner;
                  let refRepo = repo;
                  let refNum;

                  if (ref.includes('/')) {
                    const [fullRepo, num] = ref.split('#');
                    [refOwner, refRepo] = fullRepo.split('/');
                    refNum = parseInt(num);
                  } else {
                    refNum = parseInt(ref.replace('#', ''));
                  }

                  try {
                    const refIssue = await github.rest.issues.get({
                      owner: refOwner,
                      repo: refRepo,
                      issue_number: refNum
                    });

                    if (refIssue.data.state === 'open') {
                      allClosed = false;
                      break;
                    }
                  } catch (err) {
                    console.warn(`‚ö†Ô∏è Could not resolve issue ${ref}: ${err.message}`);
                    allClosed = false;
                    break;
                  }
                }

                if (allClosed) {
                  console.log(`  üßπ Clearing comment ${comment.id} ‚Äî all references are closed.`);

                  await github.rest.issues.updateComment({
                    owner,
                    repo,
                    comment_id: comment.id,
                    body: '[This comment was auto-cleared because all referenced issues are closed.]'
                  });
                }
              }
            }
