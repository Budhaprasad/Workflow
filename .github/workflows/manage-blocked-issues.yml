name: Auto-clean Blocked by Issues

on:
  issues:
    types: [edited, reopened, closed]
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  cleanup-blocked:
    runs-on: ubuntu-latest
    steps:
      - name: Clean up closed blockers
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue?.number;
            const { owner, repo } = context.repo;

            if (!issue_number) {
              console.log("No issue context available (likely a scheduled run). Exiting.");
              return;
            }

            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });

            const body = issue.body || "";
            const match = body.match(/Blocked by Issue\(s\):\s*(.*)/i);

            if (!match) {
              console.log("No 'Blocked by Issue(s)' line found.");
              return;
            }

            const references = match[1]
              .split(',')
              .map(ref => ref.trim())
              .filter(ref => /^#\d+$/.test(ref));

            const openRefs = [];

            for (const ref of references) {
              const num = parseInt(ref.slice(1));
              try {
                const blocker = await github.rest.issues.get({ owner, repo, issue_number: num });
                if (blocker.data.state === 'open') {
                  openRefs.push(ref);
                }
              } catch (err) {
                console.warn(`Issue ${ref} not found or inaccessible.`);
              }
            }

            const newLine = openRefs.length > 0
              ? `Blocked by Issue(s): ${openRefs.join(', ')}`
              : '';

            const newBody = body.replace(/Blocked by Issue\(s\):.*/i, newLine).trim();

            if (newBody !== body) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number,
                body: newBody
              });
              console.log("Updated issue body to clean closed references.");
            } else {
              console.log("No changes needed.");
            }
