name: Clean Closed Blocked References

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # Runs every hour

jobs:
  clean-blocked-references:
    runs-on: ubuntu-latest
    steps:
      - name: Check and Clean Blocked by References
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const regex = /Blocked\s*by\s*(?:#(\d+)|\[#(\d+)\])/i;

            console.log(`ğŸ“¦ Scanning open issues in ${owner}/${repo}`);

            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open'
            });

            for (const issue of issues.data) {
              console.log(`\nğŸ” Issue #${issue.number}: ${issue.title}`);

              if (issue.comments === 0) {
                console.log(`   ğŸš« No comments found.`);
                continue;
              }

              const { data: comments } = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: issue.number
              });

              for (const comment of comments) {
                console.log(`   ğŸ’¬ Comment ID: ${comment.id}`);
                console.log(`     ğŸ“„ Raw: ${JSON.stringify(comment.body)}`);

                const match = comment.body.match(regex);
                if (!match) {
                  console.log(`     ğŸš« No 'Blocked by' reference found.`);
                  continue;
                }

                const blockedIssueNumber = parseInt(match[1] || match[2]);
                console.log(`     ğŸ”— Found reference to issue #${blockedIssueNumber}`);

                try {
                  const blockedIssue = await github.rest.issues.get({
                    owner,
                    repo,
                    issue_number: blockedIssueNumber
                  });

                  if (blockedIssue.data.state === 'closed') {
                    console.log(`     âœ… Referenced issue #${blockedIssueNumber} is closed. Removing comment.`);

                    await github.rest.issues.updateComment({
                      owner,
                      repo,
                      comment_id: comment.id,
                      body: '[Auto-cleaned: referenced issue is now closed]'
                    });
                  } else {
                    console.log(`     â³ Referenced issue #${blockedIssueNumber} is still open.`);
                  }
                } catch (error) {
                  console.warn(`     âš ï¸ Could not fetch issue #${blockedIssueNumber}: ${error.message}`);
                }
              }
            }
