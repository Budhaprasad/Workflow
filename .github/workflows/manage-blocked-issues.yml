name: Clean Up Blocked

on:
  issues:
    types: [opened, edited, reopened]
  workflow_dispatch:

jobs:
  update-blocked-comment:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;

            // Get all comments for the issue
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number
            });

            for (const comment of comments.data) {
              const match = comment.body.match(/Blocked by Issue(.*)/);
              if (!match) continue;

              const issueRefs = [...comment.body.matchAll(/#(\d+)/g)].map(m => parseInt(m[1]));
              const openIssues = [];

              for (const num of issueRefs) {
                try {
                  const issue = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: num
                  });

                  if (issue.data.state === 'open') {
                    openIssues.push(`#${num}`);
                  }
                } catch (e) {
                  console.log(`Error checking issue #${num}:`, e.message);
                }
              }

              // Rebuild the comment
              const newBody = openIssues.length > 0
                ? `Blocked by Issue ${openIssues.join(' ')}`
                : '*No longer blocked*';

              if (newBody !== comment.body) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                  body: newBody
                });
              }
            }
