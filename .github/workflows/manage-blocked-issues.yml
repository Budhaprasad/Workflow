name: Clear Blocked by Comments if Reference Is Closed

on:
  workflow_dispatch:  # You can also use schedule or push triggers

permissions:
  issues: write  # Required to update issue comments

jobs:
  clean-blocked-comments:
    runs-on: ubuntu-latest

    steps:
      - name: Check and clean "Blocked by" comments
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const regex = /Blocked\s*by\s*#(\d+)/i;

            console.log(`ğŸ” Scanning open issues in ${owner}/${repo}`);

            console.log(`   ğŸ“„ Raw Comment Body: ${JSON.stringify(comment.body)}`);

            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open'
            });

            for (const issue of issues.data) {
              console.log(`â¡ï¸ Issue #${issue.number}: ${issue.title}`);

              if (issue.comments === 0) {
                console.log(`   â›” No comments on this issue.`);
                continue;
              }

              const comments = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: issue.number
              });

              for (const comment of comments.data) {
                console.log(`   ğŸ’¬ Comment ID: ${comment.id}`);

                const match = comment.body.match(regex);
                if (!match) {
                  console.log(`     ğŸš« No 'Blocked by' reference found.`);
                  continue;
                }

                const blockedIssueNumber = parseInt(match[1]);
                console.log(`     ğŸ”— Found reference: Blocked by #${blockedIssueNumber}`);

                try {
                  const blockedIssue = await github.rest.issues.get({
                    owner,
                    repo,
                    issue_number: blockedIssueNumber
                  });

                  if (blockedIssue.data.state === 'closed') {
                    console.log(`     âœ… Issue #${blockedIssueNumber} is closed. Updating comment.`);

                    await github.rest.issues.updateComment({
                      owner,
                      repo,
                      comment_id: comment.id,
                      body: '[Auto-removed blocked-by reference: the blocking issue is now closed.]'
                    });
                  } else {
                    console.log(`     ğŸ•’ Issue #${blockedIssueNumber} is still open. Leaving comment as is.`);
                  }
                } catch (error) {
                  console.warn(`     âš ï¸ Could not fetch issue #${blockedIssueNumber}: ${error.message}`);
                }
              }
            }

